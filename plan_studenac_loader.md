# Implementacijski plan: PKG_STUDENAC_ENTRY_LEDGERS_LOAD

## Cilj in obseg
Vzpostaviti robusten PL/SQL mehanizem za:
1. sprejem CSV datoteke kot `CLOB` in shranjevanje celotnega vira,
2. ločeno procesiranje vnosov v ciljno tabelo `LOAD_STUDENAC_ENTRY_LEADGERS`,
3. standardizirano logiranje uspeha/napak z merljivimi atributi.

Izven obsega:
- UI ali aplikacijski API sloj,
- avtomatsko schedule izvajanje.

## DDL spremembe
Ustvarijo se tri pomožne tabele:

1. `STUDENAC_ENTRY_LEDGER_SOURCE`
- `source_id NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY`
- `file_name VARCHAR2(255)`
- `file_content CLOB NOT NULL`
- `received_at TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL`
- `processed_at TIMESTAMP`
- `status VARCHAR2(20)` (`RECEIVED|PROCESSING|SUCCESS|FAILED`)
- `line_count NUMBER`
- `error_message VARCHAR2(4000)`
- `created_by VARCHAR2(128) DEFAULT USER`

2. `STUDENAC_ENTRY_LEDGER_LINES_STG`
- `source_id NUMBER NOT NULL`
- `line_no NUMBER NOT NULL`
- `line_text CLOB NOT NULL`
- `created_at TIMESTAMP DEFAULT SYSTIMESTAMP`
- `PRIMARY KEY (source_id, line_no)`
- `FOREIGN KEY (source_id) REFERENCES STUDENAC_ENTRY_LEDGER_SOURCE(source_id) ON DELETE CASCADE`

3. `STUDENAC_ENTRY_LEDGER_RUN_LOG`
- `run_id NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY`
- `source_id NUMBER`
- `phase VARCHAR2(30)` (`SAVE_SOURCE|PROCESS_SOURCE|RUN`)
- `status VARCHAR2(20)` (`STARTED|SUCCESS|FAILED`)
- `started_at TIMESTAMP NOT NULL`
- `finished_at TIMESTAMP`
- `duration_ms NUMBER`
- `inserted_rows NUMBER`
- `error_code NUMBER`
- `error_message VARCHAR2(4000)`
- `created_at TIMESTAMP DEFAULT SYSTIMESTAMP`

Indeksi:
- `IDX_STUDENAC_RUN_LOG_SOURCE` na `STUDENAC_ENTRY_LEDGER_RUN_LOG(source_id)`
- `IDX_STUDENAC_SOURCE_STATUS` na `STUDENAC_ENTRY_LEDGER_SOURCE(status)`

## Package SPEC (javni API)
Package ime: `PKG_STUDENAC_ENTRY_LEDGERS_LOAD`

Javne procedure:
1. `save_source(p_file_name in varchar2, p_file_content in clob, p_source_id out number);`
2. `process_source(p_source_id in number, p_inserted_rows out number, p_status out varchar2);`
3. `run(p_file_name in varchar2, p_file_content in clob, p_source_id out number, p_inserted_rows out number, p_status out varchar2);`
4. `log_execution(p_source_id in number, p_phase in varchar2, p_status in varchar2, p_started_at in timestamp, p_finished_at in timestamp, p_inserted_rows in number, p_error_code in number default null, p_error_message in varchar2 default null);`

## Package BODY (implementacijska pravila)

### save_source
1. Validira `p_file_content` (`not null` in `dbms_lob.getlength > 0`).
2. Zapiše source v `STUDENAC_ENTRY_LEDGER_SOURCE` z `status='RECEIVED'`.
3. Vrne `p_source_id`.
4. Logira `STARTED` in `SUCCESS` za fazo `SAVE_SOURCE`.
5. `COMMIT` po uspešnem save koraku.

### process_source
1. Zaklene source zapis (`for update`) in preveri status.
2. Nastavi status source na `PROCESSING`.
3. CLOB razbije v vrstice in napolni `..._LINES_STG`.
4. Vsako vrstico parse-a s quote-aware parserjem (CSV z `,` delimiterjem).
5. Pričakuje 29 polj po vrstici; `id` iz CSV ignorira za cilj.
6. Tipna konverzija:
- date: `YYYY-MM-DD` ali `DD.MM.YYYY`
- timestamp: `YYYY-MM-DD HH24:MI:SS` ali `DD.MM.YYYY HH24:MI:SS`
- number: decimalna pika ali vejica (normalizacija)
7. Insert v `LOAD_STUDENAC_ENTRY_LEADGERS` za stolpce brez `id`.
8. Ob uspehu: source `SUCCESS`, `processed_at`, `line_count`, `COMMIT`.
9. Ob napaki: `ROLLBACK` ciljnih insertov, source `FAILED`, zapiše napako, log `FAILED`.

### run
1. Pokliče `save_source`.
2. Nato pokliče `process_source`.
3. Vrne `source_id`, `inserted_rows`, `status`.

### log_execution
- Implementacija z `PRAGMA AUTONOMOUS_TRANSACTION`.
- Izračuna `duration_ms`.
- Vedno `COMMIT` log zapisa.

## Transakcijski model
- `save_source`: samostojen commit, da je source trajno shranjen.
- `process_source`: vse ali nič glede inserta v cilj.
- Log ostane persistiran neodvisno od rollbacka glavnega toka.

## Deployment koraki
1. `sql/01_studenac_loader_tables.sql`
2. `sql/02_pkg_studenac_entry_ledgers_load.pks`
3. `sql/03_pkg_studenac_entry_ledgers_load.pkb`
4. `sql/04_studenac_loader_test_calls.sql`

## Validacijski SQL po deploymentu
1. `select count(*) from studenac_entry_ledger_source;`
2. `select count(*) from studenac_entry_ledger_lines_stg where source_id = :id;`
3. `select count(*) from load_studenac_entry_leadgers where document_id = :doc;`
4. `select phase, status, inserted_rows from studenac_entry_ledger_run_log where source_id = :id order by run_id;`

## Tveganja in mitigacije
1. Velik CLOB lahko podaljša parse čas.
- Mitigacija: staging po vrsticah + indeksi + batch insert.
2. Nekonsistentni CSV formati.
- Mitigacija: stroga validacija in jasna error sporočila.
3. Podvojeno procesiranje istega source.
- Mitigacija: status check in optional guard pred `SUCCESS` source.

## Acceptance kriteriji
1. Source datoteka se zapiše v CLOB in je berljiva.
2. Ločena akcija uspešno vstavi vrstice v `LOAD_STUDENAC_ENTRY_LEADGERS`.
3. Ob napaki v eni vrstici ni parcialnih insertov (fail-fast rollback).
4. Log vsebuje `started_at`, `finished_at`, `inserted_rows`, `status`.
5. Pokriti so oba dogovorjena formata števil in datumov.
